<!DOCTYPE html> 
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qRT-PCR ç»Ÿè®¡åˆ†æä¸“å®¶ç³»ç»Ÿ v6.5</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-error-bars@4.4.0/build/index.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #0f172a; --accent: #2563eb; --success: #10b981;
            --bg: #f8fafc; --card: #ffffff; --text: #334155; --star: #ef4444;
            --border: #e2e8f0; --warning: #fff1f2; --warning-text: #9f1239;
        }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 40px 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { border-left: 6px solid var(--accent); padding-left: 20px; margin-bottom: 35px; }
        header h1 { margin: 0; font-size: 26px; color: var(--primary); }
        .card { background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 25px; border: 1px solid var(--border); }
        .upload-box { border: 2px dashed #cbd5e1; padding: 40px; text-align: center; cursor: pointer; border-radius: 16px; background: #fff; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin: 20px 0; }
        label { font-weight: 600; font-size: 13px; margin-bottom: 8px; color: #64748b; text-transform: uppercase; }
        select, button, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; outline: none; box-sizing: border-box; }
        select[multiple] { height: 110px; }
        .btn-main { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 600; }
        .highlight-box { background: #f0f9ff; border: 1px solid #bae6fd; padding: 20px; border-radius: 12px; }
        #alert-panel { padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; display: none; }
        .alert-error { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .alert-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .chart-wrapper { height: 550px; margin: 30px 0; padding: 20px; background: #fff; border: 1px solid var(--border); border-radius: 12px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        th { background: #f8fafc; padding: 15px; font-weight: 600; font-size: 13px; }
        td { padding: 12px; text-align: center; border-top: 1px solid var(--border); font-size: 13px; }
        .outlier-row { background-color: var(--warning) !important; color: var(--warning-text); }
        .ref-tag { background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .outlier-tag { background: var(--star); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .hidden { display: none; }

        /* --- footer: simple style --- */
        .site-footer{
            margin-top: 18px;
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ§¬ qRT-PCR ç»Ÿè®¡åˆ†æä¸“å®¶ç³»ç»Ÿ v6.5</h1>
        <p>ä¸“ä¸šç»˜å›¾ Â· T-test æ£€éªŒ Â· æ™ºèƒ½å¼‚å¸¸æ£€æµ‹ (n>2)</p>
    </header>

    <div id="alert-panel"></div>

    <div class="card">
        <div class="upload-box" id="drop-zone">
            <div style="font-size: 40px;">ğŸ“‚</div>
            <p>ä¸Šä¼  Excel æ•°æ®æ–‡ä»¶</p>
            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
        </div>
    </div>

    <div id="config-section" class="card hidden">
        <h3>1. å‚æ•°æ˜ å°„</h3>
        <div class="config-grid">
            <div><label>æ ·æœ¬åˆ—</label><select id="col-sample"></select></div>
            <div><label>åŸºå› åˆ—</label><select id="col-gene"></select></div>
            <div><label>Ct å€¼åˆ—</label><select id="col-ct"></select></div>
        </div>
        <div class="config-grid">
            <div><label>å†…å‚åŸºå›  (å¤šé€‰)</label><select id="select-ref" multiple></select></div>
            <div><label>å¯¹ç…§ç»„ (Control)</label><select id="select-control"></select></div>
            <div><label>å¾…åˆ†ææ ·æœ¬</label><select id="select-target-samples" multiple></select></div>
        </div>
        <div class="highlight-box">
            <div class="config-grid" style="align-items: center; margin: 0;">
                <div><label>å›¾è¡¨åˆ†ç»„</label><select id="axis-toggle"><option value="sample">æŒ‰æ ·æœ¬åˆ†ç»„</option><option value="gene">æŒ‰åŸºå› åˆ†ç»„</option></select></div>
                <div><label>Ct SD é¢„è­¦é˜ˆå€¼</label><input type="number" id="sd-threshold" value="0.5" step="0.1"></div>
                <button class="btn-main" onclick="processData()">ğŸš€ æ‰§è¡Œç»Ÿè®¡åˆ†æ</button>
            </div>
        </div>
    </div>

    <div id="result-section" class="card hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="border:none; margin:0;">2. åˆ†ææŠ¥è¡¨</h3>
            <div style="display: flex; gap: 10px;">
                <button style="width:auto; padding:8px 15px; cursor:pointer;" onclick="exportCSV()">ğŸ“„ å¯¼å‡º CSV</button>
                <button class="btn-main" style="width:auto; background:var(--success); padding:8px 20px;" onclick="downloadChart()">ğŸ–¼ï¸ ä¸‹è½½å›¾è¡¨</button>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="pcrChart"></canvas>
        </div>
        <div style="overflow-x:auto">
            <table id="res-table">
                <thead>
                    <tr>
                        <th>æ ·æœ¬</th><th>åŸºå› </th><th>åŸå§‹ Ct åºåˆ—</th><th>Ct SD</th><th>Fold Change</th><th>FC SD</th><th>P-value</th><th>æ˜¾è‘—æ€§</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- footer -->
    <div class="site-footer">All rights reserved by zhangshuang</div>
</div>

<script>
    let rawData = [];
    let chartObj = null;
    let finalStats = [];

    // --- T-test ç»Ÿè®¡é€»è¾‘ ---
    function calculateTTest(groupA, groupB) {
        if (groupA.length < 2 || groupB.length < 2) return 1.0;
        const meanA = groupA.reduce((a, b) => a + b) / groupA.length;
        const meanB = groupB.reduce((a, b) => a + b) / groupB.length;
        const varA = groupA.reduce((a, b) => a + Math.pow(b - meanA, 2), 0) / (groupA.length - 1);
        const varB = groupB.reduce((a, b) => a + Math.pow(b - meanB, 2), 0) / (groupB.length - 1);
        const se = Math.sqrt(varA / groupA.length + varB / groupB.length);
        const t = Math.abs(meanA - meanB) / se;
        const df = groupA.length + groupB.length - 2;
        return tdist(t, df);
    }
    function tdist(t, df) {
        const x = df / (df + t * t);
        return betaIncomplete(df / 2, 0.5, x);
    }
    function betaIncomplete(a, b, x) {
        if (x === 0) return 0; if (x === 1) return 1;
        let bt = Math.exp(logGamma(a+b)-logGamma(a)-logGamma(b) + a*Math.log(x) + b*Math.log(1-x));
        if (x < (a+1)/(a+b+2)) return bt * betaFraction(a,b,x) / a;
        return 1 - bt * betaFraction(b,a,1-x) / b;
    }
    function logGamma(z) {
        const coeffs = [76.18009172947146, -86.50532032941677, 24.01409824083091, -1.231739572450155, 0.1208650973866179e-2, -0.5395239384953e-5];
        let x = z, y = z, tmp = x + 5.5; tmp -= (x + 0.5) * Math.log(tmp);
        let ser = 1.000000000190015;
        for (let j=0; j<6; j++) ser += coeffs[j] / ++y;
        return -tmp + Math.log(2.5066282746310005 * ser / x);
    }
    function betaFraction(a, b, x) {
        let m=1, m2, aa, c=1, d, del, h, qab=a+b, qap=a+1, qam=a-1;
        d = 1 - qab*x/qap; if (Math.abs(d) < 1e-30) d = 1e-30; d = 1/d; h = d;
        for (m=1; m<=100; m++) {
            m2=2*m; aa=m*(b-m)*x/((qam+m2)*(a+m2));
            d=1+aa*d; if (Math.abs(d) < 1e-30) d=1e-30; d=1/d; c=1+aa/c; if (Math.abs(c) < 1e-30) c=1e-30;
            h *= d*c; aa = -(a+m)*(qab+m)*x/((a+m2)*(qap+m2));
            d=1+aa*d; if (Math.abs(d) < 1e-30) d=1e-30; d=1/d; c=1+aa/c; if (Math.abs(c) < 1e-30) c=1e-30;
            del=d*c; h *= del; if (Math.abs(del-1.0) < 1e-7) break;
        }
        return h;
    }

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            if(rawData.length > 0) setupSelectors(Object.keys(rawData[0]));
            fileInput.value = ""; 
        };
        reader.readAsArrayBuffer(file);
    };

    function setupSelectors(headers) {
        ['col-sample', 'col-gene', 'col-ct'].forEach(id => {
            document.getElementById(id).innerHTML = headers.map(h => `<option value="${h}">${h}</option>`).join('');
        });
        const updateOptions = () => {
            const sCol = document.getElementById('col-sample').value;
            const gCol = document.getElementById('col-gene').value;
            const samples = [...new Set(rawData.map(d => d[sCol]))].filter(v => v);
            const genes = [...new Set(rawData.map(d => d[gCol]))].filter(v => v);
            document.getElementById('select-control').innerHTML = samples.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('select-target-samples').innerHTML = samples.map(s => `<option value="${s}" selected>${s}</option>`).join('');
            document.getElementById('select-ref').innerHTML = genes.map(g => `<option value="${g}">${g}</option>`).join('');
        };
        document.getElementById('col-sample').onchange = updateOptions;
        document.getElementById('col-gene').onchange = updateOptions;
        updateOptions();
        document.getElementById('config-section').classList.remove('hidden');
    }

    function processData() {
        const sCol = document.getElementById('col-sample').value;
        const gCol = document.getElementById('col-gene').value;
        const cCol = document.getElementById('col-ct').value;
        const refGenes = Array.from(document.getElementById('select-ref').selectedOptions).map(o => o.value);
        const controlGroup = document.getElementById('select-control').value;
        const targetSamples = Array.from(document.getElementById('select-target-samples').selectedOptions).map(o => o.value);
        const axisType = document.getElementById('axis-toggle').value;
        const sdThreshold = parseFloat(document.getElementById('sd-threshold').value) || 0.5;

        if(!refGenes.length) return alert("è¯·é€‰æ‹©å†…å‚åŸºå› ");

        const sampleRefAvg = {};
        const refOutlierSamples = [];
        const allSamples = [...new Set(rawData.map(d => d[sCol]))].filter(v => v);
        
        allSamples.forEach(s => {
            const vals = rawData.filter(d => d[sCol] === s && refGenes.includes(d[gCol])).map(d => parseFloat(d[cCol])).filter(v => !isNaN(v));
            const mean = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
            sampleRefAvg[s] = mean;
            
            // å†…å‚å¼‚å¸¸æ£€æµ‹ï¼šä»…åœ¨æ ·æœ¬æ•°é‡ > 2 æ—¶æ‰§è¡Œ
            const sd = vals.length > 1 ? Math.sqrt(vals.map(x => Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0)/vals.length) : 0;
            if (vals.length > 2 && sd > sdThreshold) refOutlierSamples.push(s);
        });

        const allGenes = [...new Set(rawData.map(d => d[gCol]))].filter(g => g);
        const controlDeltaMeans = {};
        allGenes.forEach(g => {
            const ctVals = rawData.filter(d => d[sCol] === controlGroup && d[gCol] === g).map(d => parseFloat(d[cCol])).filter(v => !isNaN(v));
            const deltas = ctVals.map(ct => ct - sampleRefAvg[controlGroup]);
            controlDeltaMeans[g] = deltas.length ? (deltas.reduce((a,b)=>a+b,0)/deltas.length) : 0;
        });

        finalStats = [];
        let totalOutliers = 0;
        targetSamples.forEach(s => {
            allGenes.forEach(g => {
                const ctVals = rawData.filter(d => d[sCol] === s && d[gCol] === g).map(d => parseFloat(d[cCol])).filter(v => !isNaN(v));
                if(!ctVals.length) return;

                const ctMean = ctVals.reduce((a,b)=>a+b,0)/ctVals.length;
                const ctSD = ctVals.length > 1 ? Math.sqrt(ctVals.map(x => Math.pow(x-ctMean, 2)).reduce((a,b)=>a+b,0)/ctVals.length) : 0;
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šä»…åœ¨å­”æ•° > 2 æ—¶æ£€æµ‹ç¦»ç¾¤å€¼
                const isOutlier = ctVals.length > 2 && ctSD > sdThreshold;
                if(isOutlier) totalOutliers++;

                const isRef = refGenes.includes(g);
                const fcs = ctVals.map(ct => Math.pow(2, -((ct - sampleRefAvg[s]) - controlDeltaMeans[g])));
                const fcMean = fcs.reduce((a,b)=>a+b,0)/fcs.length;
                const fcSD = fcs.length > 1 ? Math.sqrt(fcs.map(x => Math.pow(x-fcMean,2)).reduce((a,b)=>a+b,0)/fcs.length) : 0;

                const controlCtVals = rawData.filter(d => d[sCol] === controlGroup && d[gCol] === g).map(d => parseFloat(d[cCol])).filter(v => !isNaN(v));
                const pVal = (s !== controlGroup) ? calculateTTest(ctVals.map(ct => ct - sampleRefAvg[s]), controlCtVals.map(ct => ct - sampleRefAvg[controlGroup])) : 1.0;
                let sig = (pVal < 0.001) ? "***" : (pVal < 0.01) ? "**" : (pVal < 0.05) ? "*" : "ns";

                finalStats.push({ sample: s, gene: g, ctVals: ctVals.join(', '), ctSD, isOutlier, fcMean, fcSD, pVal, sig, isRef });
            });
        });

        const alertPanel = document.getElementById('alert-panel');
        if (refOutlierSamples.length > 0) {
            alertPanel.innerHTML = `âš ï¸ è­¦å‘Šï¼šæ ·æœ¬ [${refOutlierSamples.join(', ')}] çš„å†…å‚å˜å¼‚å¤§ (n>2, SD>${sdThreshold})ã€‚`;
            alertPanel.className = 'alert-error';
            alertPanel.style.display = 'block';
        } else if (totalOutliers > 0) {
            alertPanel.innerHTML = `â„¹ï¸ æç¤ºï¼šæ£€æµ‹åˆ° ${totalOutliers} ç»„å¹³è¡Œå­”å­˜åœ¨ç¦»ç¾¤é£é™© (n>2)ã€‚`;
            alertPanel.className = 'alert-error';
            alertPanel.style.display = 'block';
        } else {
            alertPanel.innerHTML = `âœ… éªŒè¯é€šè¿‡ï¼šæ•°æ®ä¸€è‡´æ€§è‰¯å¥½æˆ–é‡å¤å­”æ•°é‡ä¸è¶³ä»¥åˆ¤å®šç¦»ç¾¤ã€‚`;
            alertPanel.className = 'alert-success';
            alertPanel.style.display = 'block';
        }

        renderUI(targetSamples, allGenes.filter(g => !refGenes.includes(g)), axisType);
    }

    const starPlugin = {
        id: 'starPlugin',
        afterDraw: (chart) => {
            const { ctx } = chart;
            ctx.save(); ctx.textAlign = 'center'; ctx.font = 'bold 15px sans-serif'; ctx.fillStyle = '#ef4444';
            chart.data.datasets.forEach((dataset, i) => {
                chart.getDatasetMeta(i).data.forEach((bar, index) => {
                    const val = dataset.data[index];
                    if (val && val.sig && val.sig !== 'ns') ctx.fillText(val.sig, bar.x, bar.y - 12);
                });
            });
            ctx.restore();
        }
    };

    function renderUI(samples, targetGenesOnly, axisType) {
        const tbody = document.querySelector('#res-table tbody');
        tbody.innerHTML = finalStats.map(d => `
            <tr class="${d.isOutlier ? 'outlier-row' : ''}">
                <td>${d.sample}</td>
                <td>${d.gene} ${d.isRef ? '<span class="ref-tag">å†…å‚</span>' : ''}</td>
                <td>${d.ctVals}</td>
                <td>${d.ctSD.toFixed(3)} ${d.isOutlier ? '<span class="outlier-tag">å˜å¼‚å¤§</span>' : ''}</td>
                <td><b>${d.isRef ? '1.000' : d.fcMean.toFixed(3)}</b></td>
                <td>${d.isRef ? '-' : d.fcSD.toFixed(3)}</td>
                <td>${d.isRef ? '-' : d.pVal.toFixed(4)}</td>
                <td style="color:#ef4444; font-weight:bold">${d.isRef ? '-' : d.sig}</td>
            </tr>
        `).join('');

        if (chartObj) chartObj.destroy();
        const ctx = document.getElementById('pcrChart').getContext('2d');
        let labels = (axisType === 'sample') ? samples : targetGenesOnly;
        let dNames = (axisType === 'sample') ? targetGenesOnly : samples;
        const datasets = dNames.map((n, i) => ({
            label: n,
            backgroundColor: `hsla(${i * (360/dNames.length)}, 60%, 55%, 0.8)`,
            borderColor: `hsla(${i * (360/dNames.length)}, 60%, 40%, 1)`,
            borderWidth: 1.5,
            data: labels.map(l => {
                const item = finalStats.find(s => (axisType === 'sample') ? (s.sample === l && s.gene === n) : (s.gene === l && s.sample === n));
                return item ? { y: item.fcMean, yMin: item.fcMean - item.fcSD, yMax: item.fcMean + item.fcSD, sig: item.sig, pVal: item.pVal } : { y: 0, yMin: 0, yMax: 0, sig: 'ns', pVal: 1.0 };
            })
        }));

        chartObj = new Chart(ctx, {
            type: 'barWithErrorBars',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw.y.toFixed(3)} (P: ${c.raw.pVal.toFixed(4)})` } } },
                scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, title: { display: true, text: 'Fold Change (2^-Î”Î”Ct)' } }, x: { grid: { display: false } } }
            },
            plugins: [starPlugin]
        });
        document.getElementById('result-section').classList.remove('hidden');
    }

    function downloadChart() {
        const link = document.createElement('a');
        link.download = `PCR_Result.png`;
        link.href = document.getElementById('pcrChart').toDataURL('image/png', 1.0);
        link.click();
    }

    function exportCSV() {
        let csv = "\uFEFFSample,Gene,Type,RawCt,CtSD,FoldChange,PValue\n";
        finalStats.forEach(d => { csv += `${d.sample},${d.gene},${d.isRef ? 'Ref' : 'Target'},"${d.ctVals}",${d.ctSD},${d.fcMean},${d.pVal}\n`; });
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `PCR_Full_Results.csv`;
        a.click();
    }
</script>
</body>
</html>
